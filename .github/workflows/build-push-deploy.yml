name: Build, Push, and Deploy Blazor App to ACI

on:
  push:
    branches: [ "main" ]

jobs:
  build-push-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1️⃣ Checkout
    - name: Checkout code
      uses: actions/checkout@v4

    # 2️⃣ Login to Azure using Service Principal
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # 3️⃣ Build and push Docker image to ACR
    - name: Build and Push to ACR
      uses: azure/docker-login@v1
      with:
        login-server: <youracrname>.azurecr.io
        username: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientId }}
        password: ${{ fromJson(secrets.AZURE_CREDENTIALS).clientSecret }}

    - run: |
        docker build -t cmagcr.azurecr.io/blazorappdemo:latest ./BlazorAppDemo
        docker push cmagcr.azurecr.io/blazorappdemo:latest

    # 4️⃣ Deploy to Azure Container Instance
    - name: Deploy Container to ACI
      run: |
        az container create \
          --resource-group <your-resource-group> \
          --name blazorappdemo \
          --image cmagcr.azurecr.io/blazorappdemo:latest \
          --dns-name-label blazorappdemo${{ github.run_number }} \
          --ports 80 \
          --restart-policy Always
